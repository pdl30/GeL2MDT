<!--Copyright (c) 2018 Great Ormond Street Hospital for Children NHS Foundation
    Trust & Birmingham Women's and Children's NHS Foundation Trust

    Permission is hereby granted, free of charge, to any person obtaining a copy of
    this software and associated documentation files (the "Software"), to deal in
    the Software without restriction, including without limitation the rights to
    use, copy, modify, merge, publish, distribute, sublicense, and/or sell copies
    of the Software, and to permit persons to whom the Software is furnished to do
    so, subject to the following conditions:

    The above copyright notice and this permission notice shall be included in all
    copies or substantial portions of the Software.

    THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
    IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
    FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
    AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
    LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
    OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
    SOFTWARE.
-->
{% extends 'gel2mdt/base.html' %}
{% load bootstrap3 %}
{% load static %}
{% block content %}
    {% load gel2mdt_extras %}

    {% if report.status == 'blocked' %}
        <div class="alert alert-danger" role="alert"><strong>Warning, the CIP-API status for this case has been changed to "Blocked"</strong></div>
    {% endif %}
    <ul class="nav nav-tabs" data-options="deep_linking: true">
        <li class="active"><a data-toggle="tab" href="#proband">Proband</a></li>
        {% if user|has_group_permission:'can_view_pvs' %}
        <li><a data-toggle="tab" href="#variants">SNVs / Indels  <span class="badge" >{{pv_dict|count_dict}}</span> </a></li>
        {% endif %}
        {% if sample_type == 'raredisease' %}
        {% if user|has_group_permission:'can_view_svs' %}
        <li><a data-toggle="tab" href="#cnvs">CNVs {{proband_svs.count}} <span class="badge" >{{sv_dict|count_dict}}</span></a></li>
        {% endif %}
        {% if user|has_group_permission:'can_view_strs' %}
        <li><a data-toggle="tab" href="#strs">STRs {{proband_strs.count}} <span class="badge" >{{str_dict|count_dict}}</span></a></li>
        {% endif %}
        {% endif %}

        <li><a data-toggle="tab" href="#history">History</a></li>
    </ul>
    {% block javascript %}
        <script src="{% static 'js/custom.js' %}"></script>
    {% endblock %}

    <div class="tab-content">
        <div id="proband" class="tab-pane fade in active">
            <div class="container-fluid" >
            <div style="text-align:right">
                {% if config_dict|get_item:'cip_as_id' == 'True' %}
                    <h1  style="text-align:left;float:left;">{{report.ir_family.ir_family_id}}</h1>
                {% else %}
                    <h1  style="text-align:left;float:left;">{{report.ir_family.participant_family.proband.gel_id}} </h1>
             {% endif %}

            </div>

                <form role="form" method="post" enctype="multipart/form-data" action="/update_proband/{{ report.id }}">
                    {% csrf_token %}
                    <div class="row">

                        <div class="col-md-12">
                            <div class="panel panel-default">
                                {% if gelir_form.case_status.value != "C" %}
                                    <div class="panel-heading">Participant Information <span style="float:right">
                                            <a href=# data-toggle="modal" data-target="#demogModal"><i class="fas fa-pencil-alt"></i></a></span></div>
                                {% else %}
                                    <div class="panel-heading">Participant Information</div>
                                {% endif %}
                                <div class="panel-body">

                                    {% bootstrap_form_errors demogs_form %}

                                    <div class="col-md-3">
                                        {% bootstrap_label "GEL ID" %}
                                        <div class="block">
                                            {{report.ir_family.participant_family.proband.gel_id}}
                                        </div>
                                        </br>
                                        {% bootstrap_label "NHS Number" %}
                                        <div class="block">
                                            {{report.ir_family.participant_family.proband.nhs_number}}
                                        </div>
                                        </br>
                                        {% bootstrap_label "Date of Birth" %}
                                        <div class="block">
                                            {{report.ir_family.participant_family.proband.date_of_birth|date}}
                                        </div>
                                        </br>
                                        {% bootstrap_label "GEL Sample ID" %}
                                        <div class="block">
                                            {{report.sample_id}}
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        {% bootstrap_label "Forename" %}
                                        <div class="block">
                                            {{report.ir_family.participant_family.proband.forename}}
                                        </div>
                                        </br>
                                        {% bootstrap_label "Sex" %}
                                        <div class="block">
                                            {{report.ir_family.participant_family.proband.sex}}
                                        </div>
                                        </br>
                                      {% if report.sample_type == 'raredisease' %}
                                        {% bootstrap_label "Panels" %}
                                        <div class="block">

                                            {% for panel in panels %}
                                                <p>
                                                <a href="/panel/{{panel.panel.id}}">
                                                    {{panel.panel}}
                                                </a>
                                                </p>
                                            {% endfor %}
                                            <a href=# data-toggle="modal" data-target="#panelModal"><i class="fas fa-plus"></i></a>

                                        </div>
                                        </br>
                                    {% endif %}

                                    </div>


                                    <div class="col-md-3">

                                        {% bootstrap_label "Surname" %}
                                        <div class="block">
                                            {{report.ir_family.participant_family.proband.surname}}
                                        </div>

                                        </br>
                                        {% bootstrap_label "Lab Number" %}
                                        <div class="block">
                                            {% if report.ir_family.participant_family.proband.lab_number %}
                                                {{ report.ir_family.participant_family.proband.lab_number }}
                                            {% else %}
                                                <p style="color:gray">unknown</p>
                                            {% endif %}
                                        </div>
                                        </br>
                                        {% bootstrap_label "Clinician" %}
                                        <div class="block">
                                            {{report.ir_family.participant_family.clinician}}
                                            <a href=# data-toggle="modal" data-target="#changeclinicianModal"><i class="fas fa-pencil-alt"></i></a>
                                            <a href=# data-toggle="modal" data-target="#addclinicianModal"><i class="fas fa-plus"></i></a>
                                        </div>
                                    </br>
                                    {% if other_cases %}
                                     {% bootstrap_label "Other Interpretations" %}
                                        <div class="block">

                                        {% for case in other_cases %}
                                            <a href="/proband/{{case.id}}">
                                                {{case.ir_family.ir_family_id}}</a>
                                        {% endfor %}


                                    </div>
                                    {% endif %}
                                    </div>
                                    <div class="col-md-3">
                                        {% bootstrap_label "CIP ID" %}
                                        <div class="block">
                                            <a href="https://cipapi.genomicsengland.nhs.uk/interpretationportal/#/participant/{{report.ir_family.ir_family_id}}" target="_blank"><i class="fas fa-external-link-alt"></i> {{report.ir_family.ir_family_id}}</a>
                                        </div>
                                        </br>
                                        {% bootstrap_label "Local ID" %}
                                        <div class="block">
                                            {% if report.ir_family.participant_family.proband.local_id %}
                                                {{ report.ir_family.participant_family.proband.local_id }}
                                            {% else %}
                                                <p style="color:gray">unknown</p>
                                            {% endif %}
                                        </div>
                                        </br>
                                        {% bootstrap_label "GMC" %}
                                        <div class="block">
                                            {{report.ir_family.participant_family.proband.gmc}}
                                        </div>
                                        </br>
                                    </div>
                                </div>
                            </div>
                        </div>

                    </div>
                {% if report.sample_type == 'cancer' %}
                <div class=row>
                    <div class="col-md-12">

                        <div class="panel panel-default">
                            <div class="panel-heading">Clinical Information
                                {% if user|has_group_permission:'can_edit_clinical_questions' %}
                                <a href=# data-toggle="modal" data-target="#clinicalHistoryModal" class="btn btn-md btn-danger"><i ></i> Update Clinical History</a>
                                {% endif %}

                             </div>

                            <div class="panel-body">
                                <div class="col-md-3">
                                    {% bootstrap_label "Recruiting Disease" %}
                                    <div class="block">
                                        {{report.ir_family.participant_family.proband.recruiting_disease}}
                                    </div>
                                    </br>
                                    {% bootstrap_label "Disease Subtype" %}
                                    <div class="block">
                                            {{ report.ir_family.participant_family.proband.disease_subtype }}

                                    </div>
                                    </br>
                                    {% bootstrap_label "Deceased" %}
                                    <div class="block">
                                        {{report.ir_family.participant_family.proband.deceased}}
                                    </div>
                                    </br>
                                </div>
                                <div class="col-md-3">
                                    {% bootstrap_label "Disease Grade" %}
                                    <div class="block">
                                        {{report.ir_family.participant_family.proband.disease_grade}}
                                    </div>
                                    </br>
                                    {% bootstrap_label "Disease Stage" %}
                                    <div class="block">
                                            {{ report.ir_family.participant_family.proband.disease_stage }}

                                    </div>
                                </div>
                                <div class="col-md-3">
                                    {% bootstrap_label "Currently In Clinical Trial" %}
                                    <div class="block">
                                        {{report.ir_family.participant_family.proband.currently_in_clinical_trial}}
                                    </div>
                                    </br>
                                    {% bootstrap_label "Current Clinical Trial Information" %}
                                    <div class="block">
                                            {{ report.ir_family.participant_family.proband.current_clinical_trial_info }}

                                    </div>
                                    </br>
                                    {% bootstrap_label "Suitable For Clinical Trial" %}
                                    <div class="block">
                                            {{ report.ir_family.participant_family.proband.suitable_for_clinical_trial }}

                                    </div>
                                </div>
                                <div class="col-md-3">
                                    {% bootstrap_label "Previous Treatment" %}
                                    <div class="block">
                                        {{report.ir_family.participant_family.proband.previous_treatment}}
                                    </div>
                                    </br>
                                    {% bootstrap_label "Previous Testing" %}
                                    <div class="block">
                                            {{ report.ir_family.participant_family.proband.previous_testing }}

                                    </div>

                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                    {% endif %}



                    <div class=row>
                        <div class="col-md-7">

                            <div class="panel panel-default">
                                <div class="panel-heading">Proband Tracking</div>
                                <div class="panel-body">
                                    <div class="col-md-6">

                                        {% bootstrap_field proband_form.outcome label='Proband Outcome'%}
                                        {% bootstrap_field proband_form.comment  label='Proband Comment'%}

                                    </div>
                                    <div class="col-md-6" style="height: 250px; overflow-y:scroll;">
                                        {% bootstrap_label "Case Comments" %}
                                        <a href=# data-toggle="modal" data-target="#addCommentModal"><i class="fas fa-plus"></i></a>

                                        <div class="media"  id="comment-table">
                                            {% for comment in report.casecomment_set.all %}
                                            <div class="panel ">
                                    <div class="media-body">
                                      <h5 class="media-heading">{{comment.user.first_name}} {{comment.user.last_name}}
                                          <span style="float: right; margin: 0px 5px 0px 5px">
                                              <small><i>Posted on {{comment.time}}</i></small></span></h5>
                                      <p>{{comment.comment}}</p>
                                        <p>
                                        {% if comment.user == request.user %}
                                        <span style="float: left; margin: 0px 0px 0px 0px">
                                            <a class="js-edit-comment" data-url="/edit_comment/{{ comment.id }}" style="font-size: 13px;">Edit
                                                        </a>
                                            <a href="/delete_comment/{{comment.id }}" style="font-size: 13px;" onclick="return confirm('Are you sure?')">Delete</a>
                                        </span>
                                            </p>


                                        {% endif %}

                                    </div>
                                            </div>
                                            {% endfor %}
                                            </div>
                                        </div>
                                    <div class="col-md-12">
                                        <div class="col-md-6">
                                            {% bootstrap_label "Assigned User" %}
                                            <br>
                                            <a href=# data-toggle="modal" data-target="#caseAssignModal"><i class="fas fa-user-plus"></i></a>
                                            {{ report.assigned_user.first_name }} {{ report.assigned_user.last_name }}
                                        </div>
                                        <div class="col-md-3">
                                            {% bootstrap_label "First Check" %}
                                            <br>
                                            <a href=# data-toggle="modal" data-target="#firstCheckModal"><i class="fas fa-user-plus"></i></a>
                                            {{ report.first_check.first_name }} {{ report.first_check.last_name }}
                                        </div>
                                        {% if report.first_check %}
                                            <div class="col-md-3">
                                                {% bootstrap_label "Second Check" %}
                                                <br>
                                                <a href=# data-toggle="modal" data-target="#secondCheckModal"><i class="fas fa-user-plus"></i></a>
                                                {{ report.second_check.first_name }} {{ report.second_check.last_name }}
                                            </div>
                                        {% else %}
                                            <div class="col-md-3">
                                                {% bootstrap_label "Second Check" %}
                                                <br>
                                                <i class="fas fa-user-plus" style="color:gray;"></i>
                                            </div>
                                        {% endif %}
                                    </div>
                                    </div>

                                </div>

                        </div>

                        <div class="col-md-5">

                            <div class="panel panel-default">
                                <div class="panel-heading">Status</div>
                                <div class="panel-body">
                                    <div class="col-md-12">
                                        {% bootstrap_field gelir_form.case_status %}
                                        {% if report.sample_type == 'raredisease'%}
                                        {% bootstrap_field gelir_form.mdt_status %}
                                        {% else %}
                                        {% bootstrap_field gelir_form.mdt_status label='GTAB Status' %}
                                        {% endif %}
                                        {% bootstrap_label "CIP-API status" %} &emsp; {{ report.status }}
                                    </div>

                                    <div class="col-md-2">
                                        {% bootstrap_field gelir_form.case_sent %}
                                    </div>
                                    <div class="col-md-2">
                                        {% bootstrap_field gelir_form.pilot_case %}
                                    </div>
                                    {% if report.sample_type == "cancer" %}
                                    <div class="col-md-3">
                                        {% bootstrap_field gelir_form.no_primary_findings label="No Actionable Findings" %}
                                    </div>
                                    {% else %}
                                    <div class="col-md-3">
                                        {% bootstrap_field gelir_form.no_primary_findings label="No Primary Findings" %}
                                    </div>
                                    {% endif %}
                                    <div class="col-md-3">
                                        {% bootstrap_field gelir_form.case_code label='Case Code' %}
                                    </div>
                                    {% if sample_type == 'raredisease' %}
                                    {% if proband_mdt|length > 0 %}
                                        <div class="col-md-2">
                                            <a href="/export_mdt_outcome_form/{{report.id}}"><i class="fas fa-external-link-alt"></i> MDM Outcome</a>
                                        </div>
                                    {% endif %}
                                    {% endif %}
                                    {% if sample_type == 'cancer' %}
                                    <div class="col-md-2">
                                            <a href="/export_gtab_template/{{report.id}}"><i class="fas fa-external-link-alt"></i> GTAB Template</a>
                                        </div>
                                    <div class="col-md-2">
                                            <a href="/run_sv_extraction/{{report.id }}"><i class="fas fa-external-link-alt"></i>SV lookups</a>
                                        </div>
                                    {% endif %}
                                    <div class="col-md-12">
                                        {% if gelir_form.case_status.value != "C" %}
                                            </br>
                                            <button type="submit" name="case_update" class="btn btn-primary btn">Save</button>
                                        {% elif user|has_group_permission:'can_edit_completed_proband' %}

                                            </br>
                                            <button type="submit" name="case_update" class="btn btn-primary btn">Save</button>
                                        {% endif %}


                                        {% if sample_type == 'raredisease' %}

                                        {% if user|has_group_permission:'can_get_gel_report' %}
                                            <span>
                                                <a href="/genomics_england_report/{{report.id}}" class="btn btn-warning" role="button">Clinical Report</a>
                                            </span>
                                        {% endif %}
                                         {% endif %}


                                        <span style="float: right; margin: 0px 5px 0px 5px">
                                            <a href="/proband/{{report.id}}/report/negative" target="_blank" class="btn btn-info" role="button">Negative Report</a>
                                        </span>
                                        <span style="float: right; margin: 0px 5px 0px 5px">
                                            <a href="#" data-toggle="modal" data-target="#reportingModal" class="btn btn-warning" role="button">Positive Report</a>
                                        </span>

                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>

                <div id="reportingModal" class="modal fade" role="dialog">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header">
                                <button type="button" class="close" data-dismiss="modal"><i class="fas fa-window-close"></i></button>
                                <h4 class="modal-title">Variants for Reporting</h4>
                            </div>

                            <div class="modal-body">
                                        {% if variants_for_reporting %}
                                <table class="table table-bordered table-condensed">
                                    <thead>
                                        <tr>
                                            <th><i class="fas fa-plus-circle"></i></th>
                                            <th>Gene</th>
                                            <th>HGVS description</th>
                                            <th>Classification</th>
                                            </th>
                                    </thead>
                                    <tbody>
                                        {% for variant in variants_for_reporting %}
                                            <tr>
                                            <td><div class="checkbox">
                                                    <label><input type="checkbox" name="reportVariantChoice" value="{{variant.id}}"></label>
                                                </div></td>
                                                <td>{{variant.proband_variant.get_transcript.gene}}</td>
                                                <td>
                                                    {{variant.proband_variant.get_transcript_variant.hgvs_c}}
                                                    {% if variant.proband_variant.get_transcript_variant.hgvs_p %}
                                                        <br>
                                                        {{variant.proband_variant.get_transcript_variant.hgvs_p}}
                                                    {% endif %}
                                                </td>
                                                <td>{{variant.classification}}</td>
                                            </tr>
                                            {% endfor %}
                                    </tbody>
                                </table>
                                <a target="_blank" id="btnSendVariants" class="btn btn-active" role="button">Generate</a>
                                {%else%}
                                    <p>No class 3, 4, or 5 variants which have passed validation found for this patient.</p>
                                    {% endif %}
                            </div>
                        </div>
                    </div>
                </div>

    <script>
        $(document).ready(function() {
            $("#btnSendVariants").click(function() {
                var url="/proband/{{report.id}}/report/positive?rdr=";
                var flag=false;
                $("input:checkbox[name=reportVariantChoice]:checked").each(function() {
                    if (!flag) {
                        url=url+$(this).val();
                        flag=true;
                    } else {
                        url=url+"&rdr="+$(this).val();
                    }
                })
                window.open(url, '_blank');
           })
        })
    </script>

                {% if proband_mdt %}
                    <div class="row">
                        <div class="col-md-12">
                            <div class="panel panel-default">
                                <div class="panel-heading">MDT History</div>
                                <div class="panel-body">
                                    <div class="col-md-15">
                                        <table width="100%" class="table table-striped table-bordered table-hover">
                                            <thead>
                                                <tr>
                                                    {% if report.sample_type == 'raredisease' %}
                                                    <th>MDT Name</th>
                                                    <th>MDT Date</th>
                                                        {% else %}
                                                        <th>GTAB Name</th>
                                                    <th>GTAB Date</th>
                                                        {% endif  %}
                                                    <th>Status</th>
                                                    <th>Creator</th>

                                                </tr>
                                            </thead>
                                            <tbody>
                                                {% for mdt in proband_mdt %}
                                                    <tr>
                                                        <td><a href="/mdt_view/{{ mdt.MDT.id }}">{{ mdt.MDT.id }}</a></td>
                                                        <td>{{mdt.MDT.date_of_mdt|date}}</td>
                                                        <td>{{mdt.MDT.get_status_display}}</td>
                                                        <td>{{mdt.MDT.creator}}</td>

                                                    </tr>
                                                {% endfor %}


                                            </tbody>
                                        </table>

                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                {% endif %}

                {% if relatives %}
                    <div class=row>
                        <div class="col-md-12">
                            <div class="panel panel-default">
                                <div class="panel-heading">Relatives</div>
                                <div class="panel-body">
                                    <table width="100%" class="table table-striped table-bordered table-hover" id="relative-table">
                                        <thead>
                                            <tr>
                                                <th>Relationship</th>
                                                <th>Forename</th>
                                                <th>Surname</th>
                                                <th>DOB</th>
                                                <th>NHS number</th>
                                                <th>ID</th>
                                                <th>Affected status</th>
                                                <th>Edit Relative</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for relative in relatives %}
                                                <tr>

                                                    <td>{{relative.relation_to_proband}}</td>
                                                    <td>{{relative.forename}}</td>
                                                    <td>{{relative.surname}}</td>
                                                    <td>{{relative.date_of_birth|date}}</td>
                                                    <td>{{relative.nhs_number}}</td>
                                                    <td>{{relative.gel_id}}</td>
                                                    <td>{{relative.affected_status}}</td>
                                                    <td><button type="button" class="btn btn-xs btn-danger js-edit-relative"
                                                                              data-url="/edit_relative/{{ relative.id }}">
                                                            Edit
                                                        </button></td>
                                                </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>

                                </div>
                            </div>
                        </div>
                    </div>
                {% endif %}


            </div>
        </div>

        <div id="variants" class="tab-pane fade">
            <div class="container-fluid" >
                {% if config_dict|get_item:'cip_as_id' == 'True' %}
                    <h1>{{report.ir_family.ir_family_id}}</h1>
                {% else %}
                    <h1>{{report.ir_family.participant_family.proband.gel_id}}</h1>
                {% endif %}
                <div class="row">

                    <div class="col-md-12">
                        <div class="panel panel-default">
                            <div class="panel-heading">Participant Information</div>
                            <div class="panel-body">
                                <div class="container-fluid" >
                                    <div class="row">

                                        <div class="col-md-2">
                                            {% bootstrap_label "GEL ID" %}
                                            <div class="block">
                                                {{report.ir_family.participant_family.proband.gel_id}}
                                            </div>
                                        </div>
                                        <div class="col-md-2">
                                            {% bootstrap_label "Forename" %}
                                            <div class="block">
                                                {{report.ir_family.participant_family.proband.forename}}
                                            </div>
                                        </div>
                                        <div class="col-md-2">
                                            {% bootstrap_label "Surname" %}
                                            <div class="block">
                                                {{report.ir_family.participant_family.proband.surname}}
                                            </div>
                                        </div>
                                        <div class="col-md-2">
                                            {% bootstrap_label "CIP ID" %}
                                            <div class="block">
                                                <a href="https://cipapi.genomicsengland.nhs.uk/interpretationportal/#/participant/{{report.ir_family.ir_family_id}}" target="_blank">{{report.ir_family.ir_family_id}}</a>
                                            </div>
                                        </div>
                                        {% if user|has_group_permission:'pull_t3_variants' %}
                                        {% if config_dict|get_item:'pull_T3' == 'False' %}
                                            <div class="col-md-2">
                                                {% bootstrap_label "Pull Tier3 Variants" %}
                                                <div class="block">
                                                    <a href="/pull_t3_variants/{{report.id}}">Link</a>
                                                </div>
                                            </div>
                                        {% endif %}
                                         {% endif %}
                                        {% if user|has_group_permission:'can_edit_gelir' %}
                                        <div class="col-md-2">
                                            {% bootstrap_label "Add a new variant" %}
                                            <div class="block">
                                                <a href=# data-toggle="modal" data-target="#addvariantModal"><i class="fas fa-plus"></i></a>
                                            </div>
                                        </div>
                                        {% endif %}
                                    </div>
                                    <div class="row">

                                        <div class="col-md-2">
                                            {% if report.sample_type == 'raredisease'%}
                                            {% bootstrap_label "MDT Discussion" %}
                                            {% else %}
                                            {% bootstrap_label "GTAB Discussion" %}
                                            {% endif %}
                                            <div class="block">
                                                {{report.ir_family.participant_family.proband.discussion}}
                                            </div>
                                        </div>
                                        <div class="col-md-2">
                                            {% if report.sample_type == 'raredisease'%}
                                            {% bootstrap_label "MDT Action" %}
                                            {% else %}
                                            {% bootstrap_label "GTAB Action" %}
                                            {% endif %}
                                            <div class="block">
                                                {{report.ir_family.participant_family.proband.action}}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>


                        </div>
                    </div>
                </div>
                <div class="row">
                <div class="panel-body">
                    <div class="table-responsive">
                        <table class="table table-striped table-bordered table-hover" id="dataTables-pv">
                            <thead style='font-size: 75%'>
                                <tr>
                                    <th>Variant</th>
                                    <th>Interpretation</th>
                                    <th>Gene <a href="#" data-toggle="tooltip" title="Click to set PreferredTranscript"><i class="fas fa-info-circle"></i></a></th>
                                {% if report.sample_type == 'cancer' %}
                                    <th>Domain</th>
                                {% else %}
                                    <th>Tier</th>
                                {% endif %}
                                    <th>Flag</th>
                                    {% if report.sample_type == 'raredisease' %}
                                    <th>Preferred Transcript </th>
                                    {% endif %}
                                    <th>Selected Transcript</th>
                                    <th>HGVSc</th>
                                    <th>HGVSp</th>
                                    <th>Genotype</th>
                                    {% if report.sample_type == 'cancer' %}
                                    <th>Somatic status</th>
                                    {% else %}
                                    <th>Inheritance</th>
                                    {% endif %}
                                    <th>Validation Status</th>
                                </tr>
                            </thead>
                            <tbody style='font-size: 75%'>

                                {% for pv, pv_items in pv_dict.items %}
                                    <tr >
                                        <td>
                                            <a href="/variant/{{pv.variant.id }}">
                                                <i class="fas fa-external-link-alt fa-2x"></i>
                                            </a>
                                        </td>
                                        <td>
                                            <a href=# data-toggle="modal" data-target="#pvModal{{forloop.counter}}">
                                                <i class="fas fa-info-circle fa-2x"></i>
                                            </a>
                                        </td>

                                        {% if report.sample_type == 'raredisease' %}
                                        <div id="pvModal{{forloop.counter}}" class="modal fade" role="dialog">
                                            <div class="modal-dialog">
                                                <div class="modal-content">
                                                    <div class="modal-header">
                                                        <button type="button" class="close" data-dismiss="modal"><i class="fas fa-window-close"></i></button>
                                                        <h4 class="modal-title">MDT Results</h4>
                                                    </div>
                                                    <div class="modal-body">
                                                        <label>Variant Classification</label>
                                                        <br>
                                                        {{ pv_items.raredisease_report.get_classification_display }}
                                                        <hr>
                                                        <label>Contribution to Phenotype</label>
                                                        <br>
                                                        {{ pv_items.raredisease_report.contribution_to_phenotype }}
                                                        <hr>
                                                        <label>Action from MDT</label>
                                                        <br>
                                                        {{ pv_items.raredisease_report.action }}
                                                        <hr>
                                                        <label>MDT Discussion</label>
                                                        <br>
                                                        {{ pv_items.raredisease_report.discussion }}
                                                        <hr>
                                                        <label>Change Medication?</label>
                                                        <br>
                                                        {{ pv_items.raredisease_report.change_med }}
                                                        <hr>
                                                        <label>Surgical Option?</label>
                                                        <br>
                                                        {{ pv_items.raredisease_report.surgical_option }}
                                                        <hr>
                                                        <label>Add Relative Surveillance?</label>
                                                        <br>
                                                        {{ pv_items.raredisease_report.add_surveillance_for_relatives }}
                                                        <hr>
                                                        <label>Add Clinical Trial?</label>
                                                        <br>
                                                        {{ pv_items.raredisease_report.clinical_trial }}
                                                        <hr>
                                                        <label>Inform Reproductive Choice?</label>
                                                        <br>
                                                        {{ pv_items.raredisease_report.inform_reproductive_choice }}
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        {% else %}
                                        <div id="pvModal{{forloop.counter}}" class="modal fade" role="dialog">
                                            <div class="modal-dialog">
                                                <div class="modal-content">
                                                    <div class="modal-header">
                                                        <button type="button" class="close" data-dismiss="modal"><i class="fas fa-window-close"></i></button>
                                                        <h4 class="modal-title">MDT Results</h4>
                                                    </div>
                                                    <div class="modal-body">
                                                        <label>Variant Classification</label>
                                                        <br>
                                                        {{ pv_items.cancer_report.get_classification_display }}
                                                        <hr>
                                                        <label>Action from MDT</label>
                                                        <br>
                                                        {{ pv_items.cancer_report.action }}
                                                        <hr>
                                                        <label>MDT Discussion</label>
                                                        <br>
                                                        {{ pv_items.cancer_report.discussion }}
                                                        <hr>
                                                        <label>Action Type</label>
                                                        <br>
                                                        {{ pv_items.cacncer_report.action_type }}
                                                        <hr>
                                                        <label>Validated?</label>
                                                        <br>
                                                        {{ pv_items.cancer_report.validated }}
                                                        <hr>
                                                        <label>Validated Assay Type</label>
                                                        <br>
                                                        {{ pv_items.cancer_report.validated_assay_type }}
                                                        <hr>
                                                        <label>Variant Use</label>
                                                        <br>
                                                        {{ pv_items.cancer_report.variant_use }}
                                                        <hr>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        {% endif %}
                                        {% if pv_items.transcript %}
                                            {% if report.sample_type == 'raredisease' %}
                                                {% if user|has_group_permission:'can_select_update_transcript' %}
                                                    <td><a href="/edit_preferred_transcript/{{pv_items.transcript.gene_id}}/{{pv_items.transcript.genome_assembly.id}}" target="_blank"><i class="fas fa-external-link-alt"></i> {{pv_items.transcript.gene}}</a></td>
                                                {% else %}
                                                    <td>{{pv_items.transcript.gene}}</td>
                                                {% endif %}
                                            {% else %}
                                                <td>{{pv_items.transcript.gene}}</td>
                                            {% endif %}
                                        {% else %}
                                        <td></td>
                                        {% endif %}
                                        <td>{{ pv.max_tier }}</td>

                                        <td style="word-wrap: break-word; min-width: 75px;max-width: 75px;">{% for flag in pv.pvflag_set.all %}
                                        {{flag}};
                                        {% endfor %}</td>
                                        {% if report.sample_type == 'raredisease' %}
                                        <td>{{pv_items.preferred_transcript.transcript.name}}</td>
                                        {% endif %}
                                        <td>
                                            {% if gelir_form.case_status.value != "C" %}
                                                {% if user|has_group_permission:'can_select_update_transcript' %}
                                                    <a href="/select_transcript/{{report.id}}/{{pv.id }}"><i class="fas fa-pencil-alt"></i></a></span> {{pv_items.transcript.name }}
                                                {% else%}
                                                    {{pv_items.transcript.name }}
                                                {% endif %}
                                            {% else %}
                                            {{pv_items.transcript.name }}
                                                {% endif %}

                                        </td>

                                        <td style="word-wrap: break-word; min-width: 100px;max-width: 100px;">{{pv_items.transcript_variant.hgvs_c}}</td>
                                        <td style="word-wrap: break-word; min-width: 75px;max-width: 75px;">{{pv_items.transcript_variant.hgvs_p}}</td>
                                        <td>{{pv.zygosity}}</td>
                                        {% if report.sample_type == 'cancer' %}
                                        <td>{{pv.somatic}}</td>
                                        {% else %}
                                        <td> 
                                            <a href=# data-toggle="modal" data-target="#pvModalInheritance{{forloop.counter}}">
                                                {{pv.inheritance}}
                                            </a>
                                        </td>
                                        <div id="pvModalInheritance{{forloop.counter}}" class="modal fade" role="dialog">
                                            <div class="modal-dialog">
                                                <div class="modal-content">
                                                    <div class="modal-header">
                                                        <button type="button" class="close" data-dismiss="modal"><i class="fas fa-window-close"></i></button>
                                                        <h4 class="modal-title">Inheritance information</h4>
                                                    </div>
                                                    <div class="modal-body">
                                                        <label>Maternal zygosity</label>
                                                        <br>
                                                        {{ pv.maternal_zygosity }}
                                                        <hr>
                                                        <label>Paternal zygosity</label>
                                                        <br>
                                                        {{ pv.paternal_zygosity }}
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        {% endif %}
                                        {% if user|has_group_permission:'can_edit_validation_list' %}
                                            <td><a onclick="$('#validationModal{{forloop.counter}}').modal('show')"><i class="fas fa-pencil-alt"></i></a></span> {{pv.get_validation_status_display}}</td>
                                        {% else %}
                                        <td>{{pv.get_validation_status_display}}</td>
                                        {% endif %}
                                    </tr>

                                    <div id="validationModal{{forloop.counter}}" class="modal fade validationModal" role="dialog">
                                        <p class="pv-id" hidden>{{pv.id}}</p>
                                        <div class="modal-dialog">
                                            <div class="modal-content">
                                                <div class="modal-header">
                                                    <button type="button" class="close" data-dismiss="modal"><i class="fas fa-window-close"></i></button>
                                                    <h4 class="modal-title">{{pv_items.transcript_variant.hgvs_c}}</h4>
                                                </div>
                                                <div class="modal-body">
                                                    <h5>Validation for variant {{pv_items.transcript_variant.hgvs_c}}.</h5>
                                                    <form id="validationForm{{forloop.counter}}" action="#" method="POST">
                                                        {% csrf_token %}
                                                        {% bootstrap_form pv_items.form %}
                                                        {% buttons %}
                                                        <input value="Update" type="button" name='variant_validation' onclick="updateValidation(validationModal{{forloop.counter}});" class="btn btn-primary">
                                                        </input>
                                                        {% endbuttons %}
                                                    </form>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                {% endfor %}

                                <script>
                                    function updateValidation(modalID) {
                                        var modal = $(modalID);
                                        var CSRFToken = modal.find('input[name=csrfmiddlewaretoken]').val();
                                        var modalTitle = modal.find('.modal-title');
                                        var pvID = modal.find('.pv-id').text();
                                        console.log("Updating validation for " + modalTitle.text() + " (" + pvID + ").");
                                        var select_status = modal.find('#id_validation_status');
                                        var select_status_value = select_status.find(":selected").text();
                                        var select_user = modal.find('#id_validation_responsible_user');
                                        var select_user_value = select_user.find(":selected").text();
                                        console.log("Setting validation status as " + select_status_value);
                                        console.log("Setting validation user as " + select_user_value);
                                        $.ajax({
                                            type: 'POST',
                                            url: '/ajax_validation',
                                            data: {
                                                probandVariant: pvID,
                                                selectedStatus: select_status_value,
                                                selectedUser: select_user_value,
                                                csrfmiddlewaretoken: CSRFToken
                                            },
                                            success: function(response) {
                                                console.log("POSTed validation change:");
                                                console.log(response);
                                                select_status.find(":selected").text(response.validationStatus);
                                                select_user.find(":selected").text(response.validationUser);
                                                location.reload();
                                            }
                                        })

                                    }
                                </script>

                            </tbody>
                        </table>
                    </div>

                </div>
                </div>
            </div>
        </div>

    <div id="cnvs" class="tab-pane fade">
            <div class="container-fluid" >
                {% if config_dict|get_item:'cip_as_id' == 'True' %}
                    <h1>{{report.ir_family.ir_family_id}}</h1>
                {% else %}
                    <h1>{{report.ir_family.participant_family.proband.gel_id}}</h1>
                {% endif %}
                <div class="row">

                    <div class="col-md-12">
                        <div class="panel panel-default">
                            <div class="panel-heading">Participant Information</div>
                            <div class="panel-body">
                                <div class="container-fluid" >
                                    <div class="row">

                                        <div class="col-md-2">
                                            {% bootstrap_label "GEL ID" %}
                                            <div class="block">
                                                {{report.ir_family.participant_family.proband.gel_id}}
                                            </div>
                                        </div>
                                        <div class="col-md-2">
                                            {% bootstrap_label "Forename" %}
                                            <div class="block">
                                                {{report.ir_family.participant_family.proband.forename}}
                                            </div>
                                        </div>
                                        <div class="col-md-2">
                                            {% bootstrap_label "Surname" %}
                                            <div class="block">
                                                {{report.ir_family.participant_family.proband.surname}}
                                            </div>
                                        </div>
                                        <div class="col-md-2">
                                            {% bootstrap_label "CIP ID" %}
                                            <div class="block">
                                                <a href="https://cipapi.genomicsengland.nhs.uk/interpretationportal/#/participant/{{report.ir_family.ir_family_id}}" target="_blank">{{report.ir_family.ir_family_id}}</a>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="row">

                                        <div class="col-md-2">
                                            {% if report.sample_type == 'raredisease'%}
                                            {% bootstrap_label "MDT Discussion" %}
                                            {% else %}
                                            {% bootstrap_label "GTAB Discussion" %}
                                            {% endif %}
                                            <div class="block">
                                                {{report.ir_family.participant_family.proband.discussion}}
                                            </div>
                                        </div>
                                        <div class="col-md-2">
                                            {% if report.sample_type == 'raredisease'%}
                                            {% bootstrap_label "MDT Action" %}
                                            {% else %}
                                            {% bootstrap_label "GTAB Action" %}
                                            {% endif %}
                                            <div class="block">
                                                {{report.ir_family.participant_family.proband.action}}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>


                        </div>
                    </div>
                </div>
                <div class="row">
                <div class="panel-body">
                    <div class="table-responsive">
                        <table class="table table-striped table-bordered table-hover" id="dataTables-psv">
                            <thead style='font-size: 75%'>
                                <tr>
                                    <th>Variant</th>
                                    <th>Interpretation</th>
                                    <th>Tier</th>
                                    <th>TierA genes</th>
                                    <th>All genes in CNV</th>
                                    <th>Variant Type</th>
                                    <th>CNV AF</th>
                                    <th>CNV AUC</th>
                                    <th>Confirmation Status</th>
                                </tr>
                            </thead>
                            <tbody style='font-size: 75%'>

                                {% for proband_sv, sv_items in sv_dict.items %}
                                    <tr >
                                        <td>
                                            <a href="/sv/{{proband_sv.sv.id }}">
                                                <i class="fas fa-external-link-alt fa-2x"></i>
                                            </a>

                                            {{ proband_sv.sv }}
                                        </td>
                                        <td>
                                            <a href=# data-toggle="modal" data-target="#svModal{{forloop.counter}}">
                                                <i class="fas fa-info-circle fa-2x"></i>
                                            </a>
                                        </td>
                                            {% if report.sample_type == 'raredisease' %}
                                        <div id="svModal{{forloop.counter}}" class="modal fade" role="dialog">
                                            <div class="modal-dialog">
                                                <div class="modal-content">
                                                    <div class="modal-header">
                                                        <button type="button" class="close" data-dismiss="modal"><i class="fas fa-window-close"></i></button>
                                                        <h4 class="modal-title">MDT Results</h4>
                                                    </div>
                                                    <div class="modal-body">
                                                        <label>Variant Classification</label>
                                                        <br>
                                                        {{ sv_items.raredisease_report.get_classification_display }}
                                                        <hr>
                                                        <label>Contribution to Phenotype</label>
                                                        <br>
                                                        {{ sv_items.raredisease_report.contribution_to_phenotype }}
                                                        <hr>
                                                        <label>Action from MDT</label>
                                                        <br>
                                                        {{ sv_items.raredisease_report.action }}
                                                        <hr>
                                                        <label>MDT Discussion</label>
                                                        <br>
                                                        {{ sv_items.raredisease_report.discussion }}
                                                        <hr>
                                                        <label>Change Medication?</label>
                                                        <br>
                                                        {{ sv_items.raredisease_report.change_med }}
                                                        <hr>
                                                        <label>Surgical Option?</label>
                                                        <br>
                                                        {{ sv_items.raredisease_report.surgical_option }}
                                                        <hr>
                                                        <label>Add Relative Surveillance?</label>
                                                        <br>
                                                        {{ sv_items.raredisease_report.add_surveillance_for_relatives }}
                                                        <hr>
                                                        <label>Add Clinical Trial?</label>
                                                        <br>
                                                        {{ sv_items.raredisease_report.clinical_trial }}
                                                        <hr>
                                                        <label>Inform Reproductive Choice?</label>
                                                        <br>
                                                        {{ sv_items.raredisease_report.inform_reproductive_choice }}
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        {% endif %}
                                        <td>{{proband_sv.max_tier}}</td>
                                        <td>{% for psg in proband_sv.probandsvgene_set.all %}
                                            {% if psg.selected %}
                                            {{psg.gene}}
                                            {% endif %}
                                            {% endfor %}
                                        </td>
                                        <td>{% for psg in proband_sv.probandsvgene_set.all %}
                                            {{psg.gene}}
                                            {% endfor %}
                                        </td>
                                        <td>{{proband_sv.sv.variant_type}}</td>
                                        <td>{{proband_sv.cnv_af}}</td>
                                        <td>{{proband_sv.cnv_auc}}</td>
                                        <td><a onclick="$('#validationSVModal{{forloop.counter}}').modal('show')"><i class="fas fa-pencil-alt"></i></a></span> {{proband_sv.get_validation_status_display}}</td>
                                    </tr>

                                    <div id="validationSVModal{{forloop.counter}}" class="modal fade validationSVModal" role="dialog">
                                        <p class="proband_sv-id" hidden>{{proband_sv.id}}</p>
                                        <div class="modal-dialog">
                                            <div class="modal-content">
                                                <div class="modal-header">
                                                    <button type="button" class="close" data-dismiss="modal"><i class="fas fa-window-close"></i></button>
                                                    <h4 class="modal-title">{{proband_sv.sv}}</h4>
                                                </div>
                                                <div class="modal-body">
                                                    <h5>Validation for variant {{proband_sv.sv}}.</h5>
                                                    <form id="validationSVForm{{forloop.counter}}" action="#" method="POST">
                                                        {% csrf_token %}
                                                        {% bootstrap_form sv_items.form %}
                                                        {% buttons %}
                                                        <input value="Update" type="button" onclick="updateSVValidation(validationSVModal{{forloop.counter}});" class="btn btn-primary">
                                                        </input>
                                                        {% endbuttons %}
                                                    </form>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                {% endfor %}

                            </tbody>
                        </table>
                    </div>
                    <script>
                                    function updateSVValidation(modalID) {
                                        var modal = $(modalID);
                                        var CSRFToken = modal.find('input[name=csrfmiddlewaretoken]').val();
                                        var modalTitle = modal.find('.modal-title');
                                        var svID = modal.find('.proband_sv-id').text();
                                        console.log("Updating validation for " + modalTitle.text() + " (" + svID + ").");
                                        var select_status = modal.find('#id_validation_status');
                                        var select_status_value = select_status.find(":selected").text();
                                        var select_user = modal.find('#id_validation_responsible_user');
                                        var select_user_value = select_user.find(":selected").text();
                                        console.log("Setting validation status as " + select_status_value);
                                        console.log("Setting validation user as " + select_user_value);
                                        $.ajax({
                                            type: 'POST',
                                            url: '/ajax_validation',
                                            data: {
                                                probandSV: svID,
                                                selectedStatus: select_status_value,
                                                selectedUser: select_user_value,
                                                csrfmiddlewaretoken: CSRFToken
                                            },
                                            success: function(response) {
                                                console.log("POSTed validation change:");
                                                console.log(response);
                                                select_status.find(":selected").text(response.validationStatus);
                                                select_user.find(":selected").text(response.validationUser);
                                                location.reload();
                                            }
                                        })

                                    }
                                </script>


                </div>
                </div>
            </div>
        </div>

        <div id="strs" class="tab-pane fade">
            <div class="container-fluid" >
                {% if config_dict|get_item:'cip_as_id' == 'True' %}
                    <h1>{{report.ir_family.ir_family_id}}</h1>
                {% else %}
                    <h1>{{report.ir_family.participant_family.proband.gel_id}}</h1>
                {% endif %}
                <div class="row">

                    <div class="col-md-12">
                        <div class="panel panel-default">
                            <div class="panel-heading">Participant Information</div>
                            <div class="panel-body">
                                <div class="container-fluid" >
                                    <div class="row">

                                        <div class="col-md-2">
                                            {% bootstrap_label "GEL ID" %}
                                            <div class="block">
                                                {{report.ir_family.participant_family.proband.gel_id}}
                                            </div>
                                        </div>
                                        <div class="col-md-2">
                                            {% bootstrap_label "Forename" %}
                                            <div class="block">
                                                {{report.ir_family.participant_family.proband.forename}}
                                            </div>
                                        </div>
                                        <div class="col-md-2">
                                            {% bootstrap_label "Surname" %}
                                            <div class="block">
                                                {{report.ir_family.participant_family.proband.surname}}
                                            </div>
                                        </div>
                                        <div class="col-md-2">
                                            {% bootstrap_label "CIP ID" %}
                                            <div class="block">
                                                <a href="https://cipapi.genomicsengland.nhs.uk/interpretationportal/#/participant/{{report.ir_family.ir_family_id}}" target="_blank">{{report.ir_family.ir_family_id}}</a>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="row">

                                        <div class="col-md-2">
                                            {% if report.sample_type == 'raredisease'%}
                                            {% bootstrap_label "MDT Discussion" %}
                                            {% else %}
                                            {% bootstrap_label "GTAB Discussion" %}
                                            {% endif %}
                                            <div class="block">
                                                {{report.ir_family.participant_family.proband.discussion}}
                                            </div>
                                        </div>
                                        <div class="col-md-2">
                                            {% if report.sample_type == 'raredisease'%}
                                            {% bootstrap_label "MDT Action" %}
                                            {% else %}
                                            {% bootstrap_label "GTAB Action" %}
                                            {% endif %}
                                            <div class="block">
                                                {{report.ir_family.participant_family.proband.action}}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>


                        </div>
                    </div>
                </div>
                <div class="row">
                <div class="panel-body">
                    <div class="table-responsive">
                        <table class="table table-striped table-bordered table-hover" id="dataTables-psv">
                            <thead style='font-size: 75%'>
                                <tr>
                                    <th>Variant</th>
                                    <th>Interpretation</th>
                                    <th>Tier</th>
                                    <th>TierA genes</th>
                                    <th>All genes in STR</th>
                                    <th>Normal Threshold</th>
                                    <th>Pathogenic Threshold</th>
                                    <th>Proband Copies</th>
                                    <th>Maternal Copies</th>
                                    <th>Paternal Copies</th>
                                    <th>Mode of Inheritance</th>
                                    <th>Segregation Pattern</th>
                                    <th>Confirmation Status</th>
                                </tr>
                            </thead>
                            <tbody style='font-size: 75%'>

                                {% for proband_str, str_items in str_dict.items %}
                                    <tr >
                                        <td>
                                            <a href="/str/{{proband_str.str_variant.id }}">
                                                <i class="fas fa-external-link-alt fa-2x"></i>
                                            </a>

                                            {{ proband_str.str_variant }}
                                        </td>
                                        <td>
                                            <a href=# data-toggle="modal" data-target="#strModal{{forloop.counter}}">
                                                <i class="fas fa-info-circle fa-2x"></i>
                                            </a>
                                        </td>
                                            {% if report.sample_type == 'raredisease' %}
                                        <div id="strModal{{forloop.counter}}" class="modal fade" role="dialog">
                                            <div class="modal-dialog">
                                                <div class="modal-content">
                                                    <div class="modal-header">
                                                        <button type="button" class="close" data-dismiss="modal"><i class="fas fa-window-close"></i></button>
                                                        <h4 class="modal-title">MDT Results</h4>
                                                    </div>
                                                    <div class="modal-body">
                                                        <label>Variant Classification</label>
                                                        <br>
                                                        {{ str_items.raredisease_report.get_classification_display }}
                                                        <hr>
                                                        <label>Contribution to Phenotype</label>
                                                        <br>
                                                        {{ str_items.raredisease_report.contribution_to_phenotype }}
                                                        <hr>
                                                        <label>Action from MDT</label>
                                                        <br>
                                                        {{ str_items.raredisease_report.action }}
                                                        <hr>
                                                        <label>MDT Discussion</label>
                                                        <br>
                                                        {{ str_items.raredisease_report.discussion }}
                                                        <hr>
                                                        <label>Change Medication?</label>
                                                        <br>
                                                        {{ str_items.raredisease_report.change_med }}
                                                        <hr>
                                                        <label>Surgical Option?</label>
                                                        <br>
                                                        {{ str_items.raredisease_report.surgical_option }}
                                                        <hr>
                                                        <label>Add Relative Surveillance?</label>
                                                        <br>
                                                        {{ str_items.raredisease_report.add_surveillance_for_relatives }}
                                                        <hr>
                                                        <label>Add Clinical Trial?</label>
                                                        <br>
                                                        {{ str_items.raredisease_report.clinical_trial }}
                                                        <hr>
                                                        <label>Inform Reproductive Choice?</label>
                                                        <br>
                                                        {{ str_items.raredisease_report.inform_reproductive_choice }}
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        {% endif %}
                                        <td>{{proband_str.max_tier}}</td>
                                        <td>{% for psg in proband_str.probandstrgene_set.all %}
                                            {% if psg.selected %}
                                            {{psg.gene}}
                                            {% endif %}
                                            {% endfor %}
                                        </td>
                                        <td>{% for psg in proband_str.probandstrgene_set.all %}
                                            {{psg.gene}}
                                            {% endfor %}
                                        </td>
                                        <td>{{proband_str.str_variant.normal_threshold}}</td>
                                        <td>{{proband_str.str_variant.pathogenic_threshold}}</td>
                                        <td>{{proband_str.proband_copies_a}}, {{proband_str.proband_copies_b}}</td>
                                        <td>See Interpretation Portal</td>
                                        <td>See Interpretation Portal</td>
                                        <td>{{proband_str.mode_of_inheritance}} </td>
                                        <td>{{proband_str.segregation_pattern}} </td>
                                        <td><a onclick="$('#validationSTRModal{{forloop.counter}}').modal('show')"><i class="fas fa-pencil-alt"></i></a></span> {{proband_str.get_validation_status_display}}</td>
                                    </tr>

                                    <div id="validationSTRModal{{forloop.counter}}" class="modal fade validationSTRModal" role="dialog">
                                        <p class="proband_str-id" hidden>{{proband_str.id}}</p>
                                        <div class="modal-dialog">
                                            <div class="modal-content">
                                                <div class="modal-header">
                                                    <button type="button" class="close" data-dismiss="modal"><i class="fas fa-window-close"></i></button>
                                                    <h4 class="modal-title">{{proband_str}}</h4>
                                                </div>
                                                <div class="modal-body">
                                                    <h5>Validation for variant {{proband_str}}.</h5>
                                                    <form id="validationSTRForm{{forloop.counter}}" action="#" method="POST">
                                                        {% csrf_token %}
                                                        {% bootstrap_form str_items.form %}
                                                        {% buttons %}
                                                        <input value="Update" type="button" onclick="updateSTRValidation(validationSTRModal{{forloop.counter}});" class="btn btn-primary">
                                                        </input>
                                                        {% endbuttons %}
                                                    </form>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                {% endfor %}

                            </tbody>
                        </table>
                    </div>
                    <script>
                                    function updateSTRValidation(modalID) {
                                        var modal = $(modalID);
                                        var CSRFToken = modal.find('input[name=csrfmiddlewaretoken]').val();
                                        var modalTitle = modal.find('.modal-title');
                                        var svID = modal.find('.proband_str-id').text();
                                        console.log("Updating validation for " + modalTitle.text() + " (" + svID + ").");
                                        var select_status = modal.find('#id_validation_status');
                                        var select_status_value = select_status.find(":selected").text();
                                        var select_user = modal.find('#id_validation_responsible_user');
                                        var select_user_value = select_user.find(":selected").text();
                                        console.log("Setting validation status as " + select_status_value);
                                        console.log("Setting validation user as " + select_user_value);
                                        $.ajax({
                                            type: 'POST',
                                            url: '/ajax_validation',
                                            data: {
                                                probandSTR: svID,
                                                selectedStatus: select_status_value,
                                                selectedUser: select_user_value,
                                                csrfmiddlewaretoken: CSRFToken
                                            },
                                            success: function(response) {
                                                console.log("POSTed validation change:");
                                                console.log(response);
                                                select_status.find(":selected").text(response.validationStatus);
                                                select_user.find(":selected").text(response.validationUser);
                                                location.reload();
                                            }
                                        })

                                    }
                                </script>


                </div>
                </div>
            </div>
        </div>

    <div id="history" class="tab-pane fade">
            <div class="container-fluid" >
                <div class="row">
                    <div class="col-md-12">
                        <div class="panel panel-default">
                            <div class="panel-heading">Report History</div>
                            <div class="panel-body">
                                <div class="table-responsive">
                                    <table class="table table-striped table-bordered table-hover" >
                            <thead style='font-size: 75%'>
                                <tr>
                                    <th>User </th>
                                    <th>Date Changed</th>
                                    <th>assigned_user</th>
                                    <th>case_sent</th>
                                    <th>case_status</th>
                                    <th>mdt_status</th>
                                    <th>pilot_case</th>
                                    <th>no_primary_findings</th>
                                </tr>
                            </thead>
                            <tbody style='font-size: 75%'>
                                {% for history in report_history %}
                                     {%  if forloop.counter0  == 0 %}
                                     {% if history.diff.0 %}
                                     <tr>
                                    <td>{{ history.revision.user}}</td>
                                    <td>{{ history.revision.date_created }}</td>
                                     {% for field in report_fields %}
                                     {% if field in history.diff.1 %}
                                         <td>{{ history.serialized_data.0.fields|get_item:field }}</td>
                                     {% else %}
                                         <td></td>
                                     {% endif %}
                                         {% endfor %}
                                    {% endif %}
                                    {% else %}
                                    {% if history.diff.0 %}
                                     <tr>
                                    <td>{{ history.revision.user}}</td>
                                    <td>{{ history.revision.date_created }}</td>
                                     {% for field in report_fields %}
                                     {% if field in history.diff.1 %}
                                         <td bgcolor="#90ee90">{{ history.serialized_data.0.fields|get_item:field }}</td>
                                     {% else %}
                                         <td></td>
                                     {% endif %}
                                         {% endfor %}
                                    {% endif %}
                                    {% endif %}

    {% endfor %}
                            </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    <div class="panel panel-default">
                            <div class="panel-heading">Proband History</div>
                            <div class="panel-body">
                                <div class="table-responsive">
                                    <table class="table table-striped table-bordered table-hover" >
                            <thead style='font-size: 75%'>
                                <tr>
                                    <th>User </th>
                                    <th>Date Changed</th>
                                    <th>forename</th>
                                    <th>surname</th>
                                    <th>date_of_birth</th>
                                    <th>nhs_number</th>
                                    <th>sex</th>
                                    <th>outcome</th>
                                    <th>comment</th>
                                    <th>discussion</th>
                                    <th>action</th>
                                    <th>gmc</th>
                                    <th>lab_number</th>
                                    <th>local_id</th>
                                    <th>deceased</th>
                                    <th>disease_group</th>
                                    <th>recruiting_disease</th>
                                    <th>disease_subtype</th>
                                    <th>disease_stage</th>
                                    <th>disease_grade</th>
                                    <th>currently_in_clinical_trial</th>
                                    <th>current_clinical_trial_info</th>
                                    <th>suitable_for_clinical_trial</th>
                                    <th>previous_testing</th>
                                    <th>previous_treatment</th>
                                </tr>
                            </thead>
                            <tbody style='font-size: 75%'>
                                {% for history in proband_history %}
                                     {%  if forloop.counter0  == 0 %}
                                     {% if history.diff.0 %}
                                     <tr>
                                    <td>{{ history.revision.user}}</td>
                                    <td>{{ history.revision.date_created }}</td>
                                     {% for field in proband_fields %}
                                     {% if field in history.diff.1 %}
                                         <td>{{ history.serialized_data.0.fields|get_item:field }}</td>
                                     {% else %}
                                         <td></td>
                                     {% endif %}
                                         {% endfor %}
                                    {% endif %}
                                    {% else %}
                                    {% if history.diff.0 %}
                                     <tr>
                                    <td>{{ history.revision.user}}</td>
                                    <td>{{ history.revision.date_created }}</td>
                                     {% for field in proband_fields %}
                                     {% if field in history.diff.1 %}
                                         <td bgcolor="#90ee90">{{ history.serialized_data.0.fields|get_item:field }}</td>
                                     {% else %}
                                         <td></td>
                                     {% endif %}
                                         {% endfor %}
                                    {% endif %}
                                    {% endif %}

    {% endfor %}
                            </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
    </div>
    </div>


    <div id="caseAssignModal" class="modal fade" role="dialog">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal"><i class="fas fa-window-close"></i></button>
                    <h4 class="modal-title">Assign case to user</h4>
                </div>
                <div class="modal-body">

                    <form action="/proband/{{ report.id }}" method="POST">
                        {% csrf_token %}
                        {% bootstrap_form case_assign_form %}
                        {% buttons %}
                        <button type="submit" name="case_assign" class="btn btn-primary">
                            Update
                        </button>
                        {% endbuttons %}
                    </form>

                </div>
            </div>
        </div>
    </div>

    <div id="firstCheckModal" class="modal fade" role="dialog">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal"><i class="fas fa-window-close"></i></button>
                    <h4 class="modal-title">First check performed by:</h4>
                </div>
                <div class="modal-body">

                    <form action="/proband/{{ report.id }}" method="POST">
                        {% csrf_token %}
                        {% bootstrap_form first_check_form %}
                        {% buttons %}
                        <button type="submit" name="first_check_assign" class="btn btn-primary">
                            Update
                        </button>
                        {% endbuttons %}
                    </form>

                </div>
            </div>
        </div>
    </div>

    <div id="secondCheckModal" class="modal fade" role="dialog">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal"><i class="fas fa-window-close"></i></button>
                    <h4 class="modal-title">Second check performed by:</h4>
                </div>
                <div class="modal-body">

                    <form action="/proband/{{ report.id }}" method="POST">
                        {% csrf_token %}
                        {% bootstrap_form second_check_form %}
                        {% buttons %}
                        <button type="submit" name="second_check_assign" class="btn btn-primary">
                            Update
                        </button>
                        {% endbuttons %}
                    </form>

                </div>
            </div>
        </div>
    </div>


    <div id="demogModal" class="modal fade" role="dialog">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal"><i class="fas fa-window-close"></i></button>
                    <h4 class="modal-title">Edit proband information</h4>
                </div>
                <div class="modal-body">
                    <form action="/proband/{{ report.id }}" method="POST">
                        {% csrf_token %}
                        {% bootstrap_form demogs_form %}
                        {% buttons %}
                        <button type="submit" name="demog" class="btn btn-primary">
                            Update
                        </button>
                        {% endbuttons %}
                    </form>
                </div>
            </div>
        </div>
    </div>

    <div id="panelModal" class="modal fade" role="dialog">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal"><i class="fas fa-window-close"></i></button>
                    <h4 class="modal-title">Add Panel</h4>
                </div>
                <div class="modal-body">
                    <form action="/proband/{{ report.id }}" method="POST">
                        {% csrf_token %}
                        {% bootstrap_form panel_form %}
                        {% buttons %}
                        <button type="submit" name="panel_assign" class="btn btn-primary">
                            Change
                        </button>
                        {% endbuttons %}
                    </form>
                </div>
            </div>
        </div>
    </div>

    <div id="changeclinicianModal" class="modal fade" role="dialog">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal"><i class="fas fa-window-close"></i></button>
                    <h4 class="modal-title">Change Clinician</h4>
                </div>
                <div class="modal-body">
                    <form action="/proband/{{ report.id }}" method="POST">
                        {% csrf_token %}
                        {% bootstrap_form clinician_form %}
                        {% buttons %}
                        <button type="submit" name="change_clinician" class="btn btn-primary">
                            Change Clinician
                        </button>
                        {% endbuttons %}
                    </form>
                </div>
            </div>
        </div>
    </div>

    <div id="addclinicianModal" class="modal fade" role="dialog">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal"><i class="fas fa-window-close"></i></button>
                    <h4 class="modal-title">Add New Clinician</h4>
                </div>
                <div class="modal-body">
                    <form action="/proband/{{ report.id }}" method="POST">
                        {% csrf_token %}
                        {% bootstrap_form add_clinician_form %}
                        {% buttons %}
                        <button type="submit" name="add_clinician" class="btn btn-primary">
                            Add New Clinician
                        </button>
                        {% endbuttons %}
                    </form>
                </div>
            </div>
        </div>
    </div>

    <div id="addvariantModal" class="modal fade" role="dialog">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal"><i class="fas fa-window-close"></i></button>
                    <h4 class="modal-title">Add New Variant</h4>
                </div>
                <div class="modal-body">
                    <form action="/proband/{{ report.id }}" method="POST">
                        {% csrf_token %}
                        {% bootstrap_form add_variant_form %}
                        {% buttons %}
                        <button type="submit" name="add_variant" class="btn btn-primary">
                            Add New Variant
                        </button>
                        {% endbuttons %}
                    </form>
                </div>
            </div>
        </div>
    </div>

<div id="addCommentModal" class="modal fade" role="dialog">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal"><i class="fas fa-window-close"></i></button>
                    <h4 class="modal-title">Add New Comment</h4>
                </div>
                <div class="modal-body">
                    <form action="/proband/{{ report.id }}" method="POST">
                        {% csrf_token %}
                        {% bootstrap_form add_comment_form %}
                        {% buttons %}
                        <button type="submit" name="add_comment" class="btn btn-primary">
                            Add New Comment
                        </button>
                        {% endbuttons %}
                    </form>
                </div>
            </div>
        </div>
    </div>

<div id="clinicalHistoryModal" class="modal fade" role="dialog">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal"><i class="fas fa-window-close"></i></button>
                <h4 class="modal-title">Add Clinical History</h4>
            </div>
            <div class="modal-body">
                <form action="/proband/{{ report.id }}" method="POST">
                    {% csrf_token %}
                    <div class="container-fluid" >
                    <div class="row">
                    <div class="col-md-5">
                        {% bootstrap_field cancer_history_form.recruiting_disease %}
                        {% bootstrap_field cancer_history_form.disease_subtype %}
                        {% bootstrap_field cancer_history_form.disease_grade %}
                        {% bootstrap_field cancer_history_form.disease_stage %}
                    </div>
                    <div class="col-md-7">
                        {% bootstrap_field cancer_history_form.currently_in_clinical_trial %}
                        {% bootstrap_field cancer_history_form.suitable_for_clinical_trial %}
                        {% bootstrap_field cancer_history_form.current_clinical_trial_info %}
                        {% bootstrap_field cancer_history_form.deceased %}

                    </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            {% bootstrap_field cancer_history_form.previous_treatment %}
                        </div>
                        <div class="col-md-6">
                            {% bootstrap_field cancer_history_form.previous_testing %}
                        </div>
                    </div>
                        <div class="row">
                     <div class="modal-footer">
                        <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                        <button type="submit" name="cancer_history" class="btn btn-primary" >Save</button>
                      </div>
                    </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

    <div class="modal fade" id="modal-relative">
        <div class="modal-dialog">
            <div class="modal-content">
            </div>
        </div>
    </div>

    <script>


      var runloadForm = function () {
    var btn = $(this);
    $.ajax({
      url: btn.attr("data-url"),
      type: 'get',
      dataType: 'json',
      beforeSend: function () {
        $("#modal-commenthistory .modal-content").html("");
        $("#modal-commenthistory").modal("show");
      },
      success: function (data) {
        $("#modal-commenthistory .modal-content").html(data.html_form);
      }
    });
  };

   var runsaveForm = function () {
    var form = $(this);
    $.ajax({
      url: form.attr("action"),
      data: form.serialize(),
      type: form.attr("method"),
      dataType: 'json',
      success: function (data) {
        if (data.form_is_valid) {
          window.location.reload();
          $("#modal-commenthistory").modal("hide");

        }
        else {
          $("#modal-commenthistory .modal-content").html(data.html_form);
        }
      }
    });
    return false;
  };
   $("#comment-table").on("click", ".js-edit-comment", runloadForm);
  $("#modal-run").on("submit", ".js-save-comment", runsaveForm);
    </script>
    <div class="modal fade" id="modal-commenthistory">
        <div class="modal-dialog">
            <div class="modal-content">
            </div>
        </div>
    </div>

{% endblock %}
